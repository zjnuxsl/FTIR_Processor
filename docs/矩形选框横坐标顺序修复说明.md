# 矩形选框横坐标顺序修复说明

## 🐛 问题描述

在"特征峰分析"页面中，使用矩形选框工具（RectangleSelector）放大局部图形后，横坐标（X轴）的数值显示顺序不正确。

### 具体表现

**问题**：
- 使用矩形选框工具选择并放大图形的某个区域后，横坐标的数值顺序可能是从左到右递增的（左侧数值小，右侧数值大）
- 这与 FTIR 光谱图的标准显示习惯不符

**预期行为**：
- 横坐标（波数）应该从左到右递减显示（左侧数值大，右侧数值小）
- 例如：左侧显示 4000 cm⁻¹，右侧显示 400 cm⁻¹
- 这是 FTIR 光谱图的标准显示习惯（高波数在左，低波数在右）

---

## 🔍 问题根本原因

### 原因分析

1. **X 轴已倒置**：
   - 在 `update_peak_plot()` 函数中（第 2579 行），调用了 `self.peak_ax.invert_xaxis()`
   - 这确保了 X 轴是倒置的（高波数在左，低波数在右）

2. **矩形选框设置错误**：
   - 在 `on_rect_select()` 函数中（第 3870 行），使用 `sorted()` 对 x1 和 x2 排序
   - 这会导致 x1 总是小于 x2（x1 < x2）
   - 然后在第 3882 行设置 `self.peak_ax.set_xlim(x1, x2)`
   - 这就破坏了倒置的效果，导致横坐标从左到右递增（左小右大）

3. **重置功能也有问题**：
   - 在 `reset_zoom_peak()` 函数中（第 3983 行），当没有保存的原始范围时
   - 使用 `self.peak_ax.set_xlim(np.min(self.x_data), np.max(self.x_data))`
   - 这也会导致 X 轴顺序错误（左小右大）

### 错误代码示例

**`on_rect_select()` 函数（修复前）**：
```python
# 获取选框的坐标
x1, x2 = sorted([eclick.xdata, erelease.xdata])  # x1 < x2
y1, y2 = sorted([eclick.ydata, erelease.ydata])

# 设置新的视图范围
self.peak_ax.set_xlim(x1, x2)  # ❌ 错误：左小右大
self.peak_ax.set_ylim(y1, y2)
```

**`reset_zoom_peak()` 函数（修复前）**：
```python
# 使用数据范围
self.peak_ax.set_xlim(np.min(self.x_data), np.max(self.x_data))  # ❌ 错误：左小右大
self.peak_ax.set_ylim(np.min(y_data) * 0.95, np.max(y_data) * 1.05)
```

---

## ✅ 修复方案

### 修复1：`on_rect_select()` 函数

**代码位置**：第 3866-3891 行

**修复内容**：
```python
def on_rect_select(self, eclick, erelease):
    """矩形选框选择回调函数"""
    try:
        # 获取选框的坐标
        x1, x2 = sorted([eclick.xdata, erelease.xdata])
        y1, y2 = sorted([eclick.ydata, erelease.ydata])

        # 检查选框大小（避免误操作）
        if abs(x2 - x1) < 1 or abs(y2 - y1) < 0.001:
            logger.info("选框太小，忽略")
            return

        # 添加到历史记录
        self.add_zoom_history(self.peak_ax.get_xlim(), self.peak_ax.get_ylim())

        # 设置新的视图范围
        # 注意：X轴已倒置（FTIR标准：高波数在左，低波数在右）
        # 所以设置 xlim 时，较大的值在左侧，较小的值在右侧
        self.peak_ax.set_xlim(x2, x1)  # ✅ 修复：倒置，左大右小
        self.peak_ax.set_ylim(y1, y2)

        self.peak_canvas.draw()
        logger.info(f"矩形选框缩放: X=[{x2:.2f}, {x1:.2f}] (倒置), Y=[{y1:.4f}, {y2:.4f}]")

    except Exception as e:
        logger.error(f"矩形选框缩放出错: {str(e)}")
```

**关键修改**：
- 第 3882 行：`self.peak_ax.set_xlim(x1, x2)` → `self.peak_ax.set_xlim(x2, x1)`
- 添加注释说明 X 轴倒置的原因
- 更新日志信息，显示倒置后的范围

---

### 修复2：`reset_zoom_peak()` 函数

**代码位置**：第 3968-3993 行

**修复内容**：
```python
def reset_zoom_peak(self):
    """重置峰分析图形到原始视图"""
    try:
        if self.x_data is None:
            return

        # 如果有保存的原始范围，使用它；否则使用数据范围
        if self.peak_original_xlim is not None and self.peak_original_ylim is not None:
            self.peak_ax.set_xlim(self.peak_original_xlim)
            self.peak_ax.set_ylim(self.peak_original_ylim)
        else:
            # 使用数据范围
            data_type = self.peak_data_var.get()
            y_data = self.data_manager.get_data(data_type)
            if y_data is not None:
                # X轴倒置：高波数在左，低波数在右
                self.peak_ax.set_xlim(np.max(self.x_data), np.min(self.x_data))  # ✅ 修复
                self.peak_ax.set_ylim(np.min(y_data) * 0.95, np.max(y_data) * 1.05)

        # 添加到历史记录
        self.add_zoom_history(self.peak_ax.get_xlim(), self.peak_ax.get_ylim())

        self.peak_canvas.draw()
        logger.info("峰分析图形重置到原始视图")
    except Exception as e:
        logger.error(f"重置图形出错: {str(e)}")
```

**关键修改**：
- 第 3984 行：`self.peak_ax.set_xlim(np.min(self.x_data), np.max(self.x_data))` → `self.peak_ax.set_xlim(np.max(self.x_data), np.min(self.x_data))`
- 添加注释说明 X 轴倒置的原因

---

## 📊 修复效果

### 修复前

**问题**：
- ❌ 使用矩形选框放大后，横坐标从左到右递增（左小右大）
- ❌ 重置图形后，横坐标顺序可能错误
- ❌ 不符合 FTIR 光谱图的标准显示习惯

**示例**：
```
放大后的横坐标：400 cm⁻¹ (左) → 4000 cm⁻¹ (右)  ❌ 错误
```

### 修复后

**效果**：
- ✅ 使用矩形选框放大后，横坐标从左到右递减（左大右小）
- ✅ 重置图形后，横坐标顺序正确
- ✅ 符合 FTIR 光谱图的标准显示习惯（高波数在左，低波数在右）

**示例**：
```
放大后的横坐标：4000 cm⁻¹ (左) → 400 cm⁻¹ (右)  ✅ 正确
```

---

## 🧪 测试方法

### 测试步骤

1. **启动程序**
   ```bash
   python FTIR_Processor.py
   ```

2. **切换到"特征峰分析"页面**

3. **加载数据集**
   - 加载 1-2 个数据集
   - 勾选第一个数据集

4. **测试矩形选框放大功能**
   - 确保工具模式为"🔲 矩形选框"
   - 在图形中拖拽选择一个区域
   - 释放鼠标，图形自动放大到选择的区域

5. **验证横坐标顺序**
   - 检查放大后的横坐标
   - 左侧数值应该大于右侧数值
   - 例如：左侧 3000 cm⁻¹，右侧 1000 cm⁻¹

6. **测试重置功能**
   - 点击"🔄 重置视图"按钮
   - 验证横坐标顺序仍然正确（左大右小）

7. **测试缩放历史功能**
   - 使用矩形选框多次放大不同区域
   - 点击"◀ 后退"和"▶ 前进"按钮
   - 验证每次切换后横坐标顺序都正确

### 预期结果

- ✅ 矩形选框放大后，横坐标从左到右递减
- ✅ 重置视图后，横坐标顺序正确
- ✅ 缩放历史切换时，横坐标顺序始终正确
- ✅ 所有操作都记录在日志中

### 日志示例

**矩形选框缩放**：
```
INFO - 矩形选框缩放: X=[3000.00, 1000.00] (倒置), Y=[0.0000, 1.0000]
```

**重置视图**：
```
INFO - 峰分析图形重置到原始视图
```

---

## 📝 修改总结

### 修改的文件
- `FTIR_Processor.py`

### 修改的函数
- `on_rect_select()` - 修复矩形选框放大后的横坐标顺序（第 3866-3891 行）
- `reset_zoom_peak()` - 修复重置视图时的横坐标顺序（第 3968-3993 行）

### 不受影响的功能
- ✅ 数据加载
- ✅ 平滑处理
- ✅ 基线校正
- ✅ 寻峰
- ✅ 峰分析
- ✅ 数据导出
- ✅ 日志管理
- ✅ 平移功能
- ✅ 滚轮缩放功能
- ✅ 交互式选择功能
- ✅ 所有其他功能

---

## 🎯 技术要点

### FTIR 光谱图的标准显示习惯

**波数（Wavenumber）**：
- 单位：cm⁻¹（每厘米的波数）
- 范围：通常为 400-4000 cm⁻¹
- 显示习惯：**高波数在左，低波数在右**
- 原因：这是 FTIR 光谱学的国际标准

### Matplotlib 坐标轴倒置

**方法1：使用 `invert_xaxis()`**
```python
ax.invert_xaxis()  # 倒置 X 轴
```

**方法2：使用 `set_xlim()` 时设置正确的顺序**
```python
ax.set_xlim(max_value, min_value)  # 左大右小
```

**注意**：
- 如果已经调用了 `invert_xaxis()`，则在 `set_xlim()` 时也要保持倒置的顺序
- 否则会破坏倒置效果

### 本次修复的关键

**问题**：
- `sorted()` 总是返回升序排列的值（x1 < x2）
- 直接使用 `set_xlim(x1, x2)` 会导致左小右大

**解决方案**：
- 使用 `set_xlim(x2, x1)` 来保持倒置（左大右小）
- 或者使用 `set_xlim(max(x1, x2), min(x1, x2))`

---

## 📚 相关文档

- `README.md` - 项目总体说明
- `docs/功能更新总结.md` - 所有功能更新汇总
- `docs/右键菜单功能说明.md` - 右键菜单功能说明
- `docs/图形残留问题修复说明.md` - 图形残留问题修复说明

---

## 📞 技术支持

如有问题，请查看：
- 日志文件：`logs/ftir_processor.log`
- 项目文档：`README.md`
- 功能更新总结：`docs/功能更新总结.md`

---

## ✅ 总结

**问题**：矩形选框放大后横坐标顺序错误

**原因**：
1. `on_rect_select()` 中使用 `set_xlim(x1, x2)`，导致左小右大
2. `reset_zoom_peak()` 中使用 `set_xlim(min, max)`，导致左小右大

**修复**：
1. `on_rect_select()` 中改为 `set_xlim(x2, x1)`，保持左大右小
2. `reset_zoom_peak()` 中改为 `set_xlim(max, min)`，保持左大右小

**效果**：
- ✅ 矩形选框放大后，横坐标从左到右递减（符合 FTIR 标准）
- ✅ 重置视图后，横坐标顺序正确
- ✅ 所有缩放操作都保持正确的横坐标顺序

