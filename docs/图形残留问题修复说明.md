# å›¾å½¢æ®‹ç•™é—®é¢˜ä¿®å¤è¯´æ˜

## ğŸ› é—®é¢˜æè¿°

åœ¨"ç‰¹å¾å³°åˆ†æ"é¡µé¢ä¸­ï¼Œå½“ç”¨æˆ·é€šè¿‡å³é”®èœå•åˆ é™¤å³°åˆ†æè®°å½•æˆ–å–æ¶ˆé€‰æ‹©åï¼Œå›¾å½¢ä¸Šä»ç„¶æ®‹ç•™æœ‰é«˜äº®åŒºåŸŸæ²¡æœ‰è¢«æ¸…é™¤ã€‚

### å…·ä½“è¡¨ç°

1. **åˆ é™¤ç»“æœåˆ—è¡¨ä¸­çš„è®°å½•å**ï¼š
   - å›¾å½¢ä¸Šå¯¹åº”çš„ç»¿è‰²åŒºé—´æ ‡è®°ï¼ˆè™šçº¿å’Œå³°ç¼–å·ï¼‰æ²¡æœ‰å®Œå…¨æ¶ˆå¤±
   - å¯èƒ½æ®‹ç•™ç»¿è‰²å¡«å……åŒºåŸŸã€è™šçº¿æˆ–å³°ç¼–å·æ ‡æ³¨

2. **ä»å›¾å½¢åˆ é™¤åŒºé—´åˆ†æå**ï¼š
   - æ‰€æœ‰ç›¸å…³çš„å¯è§†åŒ–æ ‡è®°æ²¡æœ‰å®Œå…¨æ¸…é™¤
   - å¯èƒ½æ®‹ç•™ç»¿è‰²æˆ–é»„è‰²é«˜äº®åŒºåŸŸ

3. **å–æ¶ˆé€‰æ‹©å**ï¼š
   - é»„è‰²é«˜äº®åŒºåŸŸæ²¡æœ‰å®Œå…¨æ¶ˆå¤±
   - å¯èƒ½æ®‹ç•™é»„è‰²å¡«å……ã€è™šçº¿æˆ–åŸºçº¿

---

## ğŸ” é—®é¢˜æ ¹æœ¬åŸå› 

### åŸå› 1ï¼šSpanSelector Widget çš„æ®‹ç•™

**é—®é¢˜**ï¼š
- `SpanSelector` æ˜¯ Matplotlib çš„ä¸€ä¸ª widgetï¼Œå®ƒæœ‰è‡ªå·±çš„ç»˜åˆ¶å±‚
- å½“è°ƒç”¨ `self.peak_ax.clear()` æ—¶ï¼Œå®ƒä¼šæ¸…é™¤åæ ‡è½´ä¸Šçš„æ‰€æœ‰è‰ºæœ¯å®¶å¯¹è±¡
- ä½†æ˜¯ `SpanSelector` å¯èƒ½ä¸ä¼šè¢«å®Œå…¨æ¸…é™¤ï¼Œå¯¼è‡´æ®‹ç•™

**ä»£ç ä½ç½®**ï¼š
- `update_peak_plot()` å‡½æ•°ï¼ˆç¬¬ 2440-2623 è¡Œï¼‰

### åŸå› 2ï¼šå›¾å½¢å¯¹è±¡ç®¡ç†ä¸å½“

**é—®é¢˜**ï¼š
- `peak_range_artists` åˆ—è¡¨åœ¨åˆå§‹åŒ–æ—¶è¢«åˆ›å»ºï¼Œä½†ä»æœªè¢«ä½¿ç”¨
- æ‰€æœ‰çš„å›¾å½¢ç»˜åˆ¶éƒ½æ˜¯ç›´æ¥åœ¨ `update_peak_plot()` ä¸­è¿›è¡Œçš„
- æ²¡æœ‰æ˜¾å¼åœ°ç®¡ç†å’Œæ¸…é™¤å›¾å½¢å¯¹è±¡

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šæ­£ç¡®å¤„ç† SpanSelector çš„ç§»é™¤å’Œé‡æ–°åˆ›å»º

#### åœ¨ `update_peak_plot()` å¼€å§‹æ—¶ç§»é™¤æ—§çš„ SpanSelector

**ä»£ç ä½ç½®**ï¼šç¬¬ 2440-2451 è¡Œ

```python
# æ¸…ç©ºåæ ‡è½´
self.peak_ax.clear()

# å¦‚æœå­˜åœ¨ SpanSelectorï¼Œéœ€è¦é‡æ–°åˆ›å»ºï¼ˆå› ä¸º clear() ä¼šç§»é™¤å®ƒï¼‰
need_recreate_span_selector = False
if hasattr(self, 'peak_span_selector') and self.peak_span_selector is not None:
    if self.peak_interactive_mode:
        need_recreate_span_selector = True
    # å…ˆç§»é™¤æ—§çš„ SpanSelector
    self.peak_span_selector.set_active(False)
    self.peak_span_selector = None
```

**è¯´æ˜**ï¼š
- åœ¨è°ƒç”¨ `clear()` ä¹‹åï¼Œæ£€æŸ¥æ˜¯å¦å­˜åœ¨ `peak_span_selector`
- å¦‚æœå­˜åœ¨ä¸”å¤„äºäº¤äº’å¼æ¨¡å¼ï¼Œæ ‡è®°éœ€è¦é‡æ–°åˆ›å»º
- å…ˆç¦ç”¨å¹¶ç§»é™¤æ—§çš„ `SpanSelector`

#### åœ¨ `update_peak_plot()` æœ«å°¾é‡æ–°åˆ›å»º SpanSelector

**ä»£ç ä½ç½®**ï¼šç¬¬ 2606-2623 è¡Œ

```python
self.peak_fig.tight_layout()

# å¦‚æœéœ€è¦é‡æ–°åˆ›å»º SpanSelector
if need_recreate_span_selector:
    from matplotlib.widgets import SpanSelector
    self.peak_span_selector = SpanSelector(
        self.peak_ax,
        self.on_peak_span_select,
        'horizontal',
        useblit=True,
        props=dict(alpha=0.3, facecolor='yellow'),
        interactive=True,
        drag_from_anywhere=True
    )
    logger.info("update_peak_plot: é‡æ–°åˆ›å»ºäº† SpanSelector")

self.peak_canvas.draw()
logger.info("update_peak_plot: å›¾å½¢ç»˜åˆ¶å®Œæˆ")
```

**è¯´æ˜**ï¼š
- åœ¨å›¾å½¢ç»˜åˆ¶å®Œæˆåï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦é‡æ–°åˆ›å»º `SpanSelector`
- å¦‚æœéœ€è¦ï¼Œä½¿ç”¨ç›¸åŒçš„å‚æ•°é‡æ–°åˆ›å»º
- è®°å½•æ—¥å¿—ï¼Œä¾¿äºè°ƒè¯•

---

### ä¿®å¤2ï¼šæ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

#### åœ¨ `clear_peak_selection()` ä¸­æ·»åŠ æ—¥å¿—

**ä»£ç ä½ç½®**ï¼šç¬¬ 3104-3121 è¡Œ

```python
def clear_peak_selection(self):
    """å–æ¶ˆå³°åˆ—è¡¨çš„é€‰æ‹©å’Œåˆ†æèŒƒå›´"""
    try:
        # æ¸…é™¤åˆ—è¡¨æ¡†ä¸­çš„é€‰æ‹©
        for item in self.peaks_tree.selection():
            self.peaks_tree.selection_remove(item)

        # æ¸…é™¤åˆ†æèŒƒå›´
        self.peak_lower_var.set("")
        self.peak_upper_var.set("")

        # æ›´æ–°å›¾å½¢æ˜¾ç¤º
        self.update_peak_plot()
        
        logger.info("å·²æ¸…é™¤å³°é€‰æ‹©å’Œåˆ†æèŒƒå›´")
    except Exception as e:
        messagebox.showerror("é”™è¯¯", f"å–æ¶ˆé€‰æ‹©å‡ºé”™ï¼š{str(e)}")
        logger.error(f"æ¸…é™¤å³°é€‰æ‹©å¤±è´¥: {str(e)}")
```

#### åœ¨ `delete_result_record()` ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—

**ä»£ç ä½ç½®**ï¼šç¬¬ 4176-4209 è¡Œ

```python
# ä» analyzed_ranges ä¸­åˆ é™¤å¯¹åº”çš„åŒºé—´
if hasattr(self, 'analyzed_ranges'):
    original_count = len(self.analyzed_ranges)
    # æŸ¥æ‰¾å¹¶åˆ é™¤åŒ¹é…çš„åŒºé—´
    self.analyzed_ranges = [
        (lower, upper, num) for lower, upper, num in self.analyzed_ranges
        if not (abs(lower - lower_limit) < 0.01 and abs(upper - upper_limit) < 0.01 and num == peak_number)
    ]
    logger.info(f"ä» analyzed_ranges åˆ é™¤åŒºé—´: åŸæœ‰{original_count}ä¸ªï¼Œç°æœ‰{len(self.analyzed_ranges)}ä¸ª")

# é‡æ–°ç»˜åˆ¶å›¾å½¢ï¼ˆç§»é™¤åŒºé—´æ ‡è®°ï¼‰
if hasattr(self, 'peak_ax') and self.peak_ax is not None:
    logger.info("è°ƒç”¨ update_peak_plot() é‡æ–°ç»˜åˆ¶å›¾å½¢")
    self.update_peak_plot()
```

#### åœ¨ `delete_analyzed_range_from_plot()` ä¸­æ·»åŠ è¯¦ç»†æ—¥å¿—

**ä»£ç ä½ç½®**ï¼šç¬¬ 4294-4328 è¡Œ

```python
# ä» analyzed_ranges ä¸­åˆ é™¤
if hasattr(self, 'analyzed_ranges'):
    original_count = len(self.analyzed_ranges)
    self.analyzed_ranges = [
        (l, u, n) for l, u, n in self.analyzed_ranges
        if not (abs(l - lower) < 0.01 and abs(u - upper) < 0.01 and n == peak_number)
    ]
    logger.info(f"ä» analyzed_ranges åˆ é™¤åŒºé—´: åŸæœ‰{original_count}ä¸ªï¼Œç°æœ‰{len(self.analyzed_ranges)}ä¸ª")

# ä»ç»“æœåˆ—è¡¨ä¸­åˆ é™¤å¯¹åº”çš„è®°å½•
deleted_from_tree = False
for item in self.result_tree.get_children():
    values = self.result_tree.item(item, 'values')
    if values:
        item_peak_number = int(values[1])
        item_lower = float(values[5])
        item_upper = float(values[6])

        if (item_peak_number == peak_number and
            abs(item_lower - lower) < 0.01 and
            abs(item_upper - upper) < 0.01):
            self.result_tree.delete(item)
            deleted_from_tree = True
            logger.info(f"ä»ç»“æœåˆ—è¡¨åˆ é™¤è®°å½•: å³°#{peak_number}")
            break

if not deleted_from_tree:
    logger.warning(f"æœªåœ¨ç»“æœåˆ—è¡¨ä¸­æ‰¾åˆ°åŒ¹é…çš„è®°å½•: å³°#{peak_number}")

# é‡æ–°ç»˜åˆ¶å›¾å½¢
if hasattr(self, 'peak_ax') and self.peak_ax is not None:
    logger.info("è°ƒç”¨ update_peak_plot() é‡æ–°ç»˜åˆ¶å›¾å½¢")
    self.update_peak_plot()
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰

**é—®é¢˜**ï¼š
- âŒ åˆ é™¤è®°å½•åï¼Œå›¾å½¢ä¸Šæ®‹ç•™ç»¿è‰²åŒºé—´æ ‡è®°
- âŒ å–æ¶ˆé€‰æ‹©åï¼Œå›¾å½¢ä¸Šæ®‹ç•™é»„è‰²é«˜äº®åŒºåŸŸ
- âŒ SpanSelector å¯èƒ½å¯¼è‡´å›¾å½¢æ®‹ç•™
- âŒ ç¼ºå°‘è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œéš¾ä»¥è°ƒè¯•

### ä¿®å¤å

**æ•ˆæœ**ï¼š
- âœ… åˆ é™¤è®°å½•åï¼Œå›¾å½¢å®Œå…¨åˆ·æ–°ï¼Œæ— ä»»ä½•æ®‹ç•™
- âœ… å–æ¶ˆé€‰æ‹©åï¼Œé»„è‰²é«˜äº®åŒºåŸŸå®Œå…¨æ¶ˆå¤±
- âœ… SpanSelector æ­£ç¡®é‡æ–°åˆ›å»ºï¼Œä¸ä¼šå¯¼è‡´æ®‹ç•™
- âœ… æ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•

---

## ğŸ§ª éªŒè¯æ–¹æ³•

### æ–¹æ³•1ï¼šæ‰‹åŠ¨æµ‹è¯•

1. å¯åŠ¨ç¨‹åºï¼Œåˆ‡æ¢åˆ°"ç‰¹å¾å³°åˆ†æ"é¡µé¢
2. åŠ è½½æ•°æ®é›†ï¼Œæ‰§è¡Œå¯»å³°
3. æ·»åŠ å¤šä¸ªå³°åˆ†æè®°å½•
4. ä½¿ç”¨å³é”®èœå•åˆ é™¤è®°å½•
5. **ä»”ç»†æ£€æŸ¥å›¾å½¢ä¸­æ˜¯å¦æœ‰ä»»ä½•æ®‹ç•™**

### æ–¹æ³•2ï¼šæŸ¥çœ‹æ—¥å¿—

æ‰“å¼€"æ—¥å¿—ç®¡ç†"é¡µé¢ï¼ŒæŸ¥çœ‹åˆ é™¤æ“ä½œçš„æ—¥å¿—ï¼š

```
INFO - ä» analyzed_ranges åˆ é™¤åŒºé—´: åŸæœ‰5ä¸ªï¼Œç°æœ‰4ä¸ª
INFO - è°ƒç”¨ update_peak_plot() é‡æ–°ç»˜åˆ¶å›¾å½¢
INFO - update_peak_plot: å¼€å§‹æ›´æ–°å›¾å½¢ï¼Œæ€»æ•°æ®é›†æ•°: 1
INFO - update_peak_plot: å‹¾é€‰çš„æ•°æ®é›†æ•°é‡: 1
INFO - update_peak_plot: å›¾å½¢ç»˜åˆ¶å®Œæˆ
INFO - å·²åˆ é™¤å³°åˆ†æè®°å½•: æ–‡ä»¶=XXX, å³°ç¼–å·=X, åŒºé—´=XXX-XXX
```

### æ–¹æ³•3ï¼šä½¿ç”¨æµ‹è¯•æŒ‡å—

å‚è€ƒ `docs/å³é”®èœå•æµ‹è¯•æŒ‡å—.md`ï¼Œæ‰§è¡Œå®Œæ•´çš„æµ‹è¯•ç”¨ä¾‹ã€‚

---

## ğŸ“ ä¿®æ”¹æ€»ç»“

### ä¿®æ”¹çš„æ–‡ä»¶
- `FTIR_Processor.py`

### ä¿®æ”¹çš„å‡½æ•°
- `update_peak_plot()` - ä¿®å¤ SpanSelector æ®‹ç•™é—®é¢˜
- `clear_peak_selection()` - æ·»åŠ æ—¥å¿—è®°å½•
- `delete_result_record()` - æ·»åŠ è¯¦ç»†æ—¥å¿—
- `delete_analyzed_range_from_plot()` - æ·»åŠ è¯¦ç»†æ—¥å¿—

### æ–°å¢çš„æ–‡æ¡£
- `docs/å›¾å½¢æ®‹ç•™é—®é¢˜ä¿®å¤è¯´æ˜.md` - æœ¬æ–‡æ¡£
- `docs/å³é”®èœå•æµ‹è¯•æŒ‡å—.md` - æµ‹è¯•æŒ‡å—

---

## ğŸ¯ æ€»ç»“

**é—®é¢˜**ï¼šå›¾å½¢æ®‹ç•™

**åŸå› **ï¼š
1. SpanSelector widget åœ¨ `clear()` åå¯èƒ½ç•™ä¸‹æ®‹ç•™
2. ç¼ºå°‘æ˜¾å¼çš„å›¾å½¢å¯¹è±¡ç®¡ç†

**ä¿®å¤**ï¼š
1. æ­£ç¡®å¤„ç† SpanSelector çš„ç§»é™¤å’Œé‡æ–°åˆ›å»º
2. æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•

**æ•ˆæœ**ï¼š
- âœ… åˆ é™¤æ“ä½œåå›¾å½¢å®Œå…¨åˆ·æ–°ï¼Œæ— æ®‹ç•™
- âœ… SpanSelector æ­£ç¡®é‡æ–°åˆ›å»º
- âœ… æ‰€æœ‰æ“ä½œéƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•

**éªŒè¯**ï¼š
- æ‰‹åŠ¨æµ‹è¯•
- æŸ¥çœ‹æ—¥å¿—
- ä½¿ç”¨æµ‹è¯•æŒ‡å—

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- æ—¥å¿—æ–‡ä»¶ï¼š`logs/ftir_processor.log`
- æµ‹è¯•æŒ‡å—ï¼š`docs/å³é”®èœå•æµ‹è¯•æŒ‡å—.md`
- åŠŸèƒ½è¯´æ˜ï¼š`docs/å³é”®èœå•åŠŸèƒ½è¯´æ˜.md`
- é¡¹ç›®æ–‡æ¡£ï¼š`README.md`

