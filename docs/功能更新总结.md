# FTIR 光谱处理器 - 功能更新总结

## 📅 更新日期
2025-11-24

---

## ✨ 本次更新内容

### 1. **修复图例颜色不一致问题** ✅ (已完成)

**问题描述**：
- 在"特征峰分析"页面中，取消勾选数据集后重新勾选，图形区域的曲线颜色与"已加载数据集"列表中的图例颜色不匹配

**修复方案**：
- 修改 `update_peak_plot()` 函数中的颜色分配逻辑
- 使用数据集在 `loaded_datasets` 中的原始索引来分配颜色，而不是 `checked_datasets` 的动态索引
- 确保每个数据集始终保持固定的颜色

**修改文件**：
- `FTIR_Processor.py` (第 2445-2453 行)

**详细文档**：
- `docs/颜色一致性修复说明.md`

---

### 2. **新增自动更新峰列表功能** ✨ (已完成)

**功能描述**：
- 当用户对某个数据集执行过寻峰操作后，切换到其他数据集时，程序会自动使用相同的寻峰参数对新数据集执行寻峰，并自动更新峰列表

**功能特点**：
- ✅ 智能触发：仅在已执行过手动寻峰后启用
- ✅ 静默执行：不显示消息框，所有操作记录在日志中
- ✅ 参数一致性：使用与手动寻峰相同的参数
- ✅ 性能优化：仅在数据集切换时触发

**修改文件**：
- `FTIR_Processor.py`
  - 第 119 行：添加寻峰标志 `has_performed_peak_finding`
  - 第 823-826 行：在 `on_dataset_click()` 中添加自动寻峰逻辑
  - 第 2999-3000 行：在 `find_peaks()` 中设置寻峰标志
  - 第 3011-3072 行：新增 `_auto_find_peaks_for_dataset()` 内部函数

**详细文档**：
- `docs/自动更新峰列表功能说明.md`

---

### 3. **新增右键菜单功能** ✨ (已完成)

**功能描述**：
- 在"特征峰分析"页面中，为峰分析结果列表和图形区域添加右键菜单功能
- 允许用户通过右键点击快速删除峰分析记录或取消区间选择

**功能特点**：

**结果列表右键菜单**：
- ✅ 右键点击结果列表中的任意记录
- ✅ 弹出"删除此记录"菜单
- ✅ 删除前显示确认对话框
- ✅ 同步删除结果列表和图形标记

**图形区域右键菜单**：
- ✅ 右键点击已分析的区间：显示"删除区间分析"选项
- ✅ 右键点击当前选择的区间：显示"取消选择"选项
- ✅ 右键点击空白区域：显示"(无可用操作)"
- ✅ 智能识别点击位置，提供相应的操作

**修改文件**：
- `FTIR_Processor.py`
  - 第 2234-2235 行：为 `result_tree` 绑定右键点击事件
  - 第 2903-2929 行：修改 `on_peak_button_press()` 添加右键处理
  - 第 4111-4137 行：新增 `on_result_tree_right_click()` 函数
  - 第 4139-4182 行：新增 `delete_result_record()` 函数
  - 第 4184-4237 行：新增 `on_peak_plot_right_click()` 函数
  - 第 4239-4287 行：新增 `delete_analyzed_range_from_plot()` 函数

**详细文档**：
- `docs/右键菜单功能说明.md`

---

### 4. **修复图形残留问题** 🐛 (已完成)

**问题描述**：
- 删除峰分析记录后，图形上仍然残留有高亮区域
- `SpanSelector` widget 在 `clear()` 后可能留下残留

**修复方案**：
- 在 `update_peak_plot()` 中正确处理 `SpanSelector` 的移除和重新创建
- 确保 `clear()` 完全清除所有图形元素
- 添加详细的日志记录，便于调试

**修改文件**：
- `FTIR_Processor.py`
  - 第 2440-2451 行：在 `update_peak_plot()` 中移除旧的 SpanSelector
  - 第 2606-2623 行：在 `update_peak_plot()` 末尾重新创建 SpanSelector
  - 第 3104-3121 行：在 `clear_peak_selection()` 中添加日志
  - 第 4176-4209 行：在 `delete_result_record()` 中添加详细日志
  - 第 4294-4328 行：在 `delete_analyzed_range_from_plot()` 中添加详细日志

**效果**：
- ✅ 删除操作后图形完全刷新，无残留
- ✅ SpanSelector 正确重新创建
- ✅ 所有操作都有详细的日志记录

---

### 5. **修复矩形选框横坐标顺序问题** 🐛 (已完成)

**问题描述**：
- 使用矩形选框工具放大图形后，横坐标（X轴）的数值顺序不正确
- 横坐标从左到右是递增的（左小右大），不符合 FTIR 光谱图的标准显示习惯
- 预期应该是从左到右递减（左大右小，高波数在左，低波数在右）

**修复方案**：
- 在 `on_rect_select()` 函数中，将 `set_xlim(x1, x2)` 改为 `set_xlim(x2, x1)`
- 在 `reset_zoom_peak()` 函数中，将 `set_xlim(min, max)` 改为 `set_xlim(max, min)`
- 确保所有缩放操作都保持正确的横坐标顺序（左大右小）

**修改文件**：
- `FTIR_Processor.py`
  - 第 3866-3891 行：修复 `on_rect_select()` 函数中的横坐标顺序
  - 第 3968-3993 行：修复 `reset_zoom_peak()` 函数中的横坐标顺序

**效果**：
- ✅ 矩形选框放大后，横坐标从左到右递减（符合 FTIR 标准）
- ✅ 重置视图后，横坐标顺序正确
- ✅ 所有缩放操作都保持正确的横坐标顺序

**详细文档**：
- `docs/矩形选框横坐标顺序修复说明.md`

---

### 6. **统一空图横坐标范围** ✨ (已完成)

**需求描述**：
- 当用户未加载任何数据时，三个页面的空白图形应该显示统一的横坐标范围
- 横坐标范围应该设置为：4000 cm⁻¹（左侧）到 400 cm⁻¹（右侧）
- 这符合 FTIR 光谱图的标准波数范围

**修复方案**：
- 在平滑处理页面初始化时，设置默认横坐标范围 4000-400 cm⁻¹
- 在基线校正页面初始化时，设置默认横坐标范围 4000-400 cm⁻¹
- 在特征峰分析页面显示空图时，设置默认横坐标范围 4000-400 cm⁻¹

**修改文件**：
- `FTIR_Processor.py`
  - 第 418-437 行：平滑处理页面初始化，添加默认横坐标范围
  - 第 527-546 行：基线校正页面初始化，添加默认横坐标范围
  - 第 2476-2485 行：特征峰分析页面显示空图，添加默认横坐标范围

**效果**：
- ✅ 三个页面的空图横坐标范围完全一致（4000-400 cm⁻¹）
- ✅ 符合 FTIR 光谱图的标准显示习惯（左大右小）
- ✅ 提升了用户体验
- ✅ 不影响加载数据后的正常显示

**详细文档**：
- `docs/统一空图横坐标范围修复说明.md`

---

## 📝 代码修改详情

### 修改 1：图例颜色一致性修复

**位置**：`FTIR_Processor.py` 第 2445-2453 行

**修改前**：
```python
for idx, dataset in enumerate(checked_datasets):
    color = self.dataset_colors[idx % len(self.dataset_colors)]
    self.peak_ax.plot(dataset['x_data'], dataset['y_data'],
                    color=color, label=dataset['name'], linewidth=1.5)
```

**修改后**：
```python
for dataset in checked_datasets:
    # 找到该数据集在 loaded_datasets 中的原始索引，以保持颜色一致
    original_idx = next(i for i, ds in enumerate(self.loaded_datasets) if ds['name'] == dataset['name'])
    color = self.dataset_colors[original_idx % len(self.dataset_colors)]
    logger.info(f"  绘制数据集: '{dataset['name']}', 原始索引: {original_idx}, 颜色: {color}, 数据点数: {len(dataset['x_data'])}")
    self.peak_ax.plot(dataset['x_data'], dataset['y_data'],
                    color=color, label=dataset['name'], linewidth=1.5)
```

---

### 修改 2：自动更新峰列表功能

#### 2.1 添加寻峰标志

**位置**：`FTIR_Processor.py` 第 119 行

```python
self.has_performed_peak_finding = False  # 标志：是否已执行过寻峰操作
```

#### 2.2 在数据集切换时触发自动寻峰

**位置**：`FTIR_Processor.py` 第 823-826 行

```python
# 自动寻峰：如果已经执行过寻峰，且当前只有一个数据集被勾选，则自动更新峰列表
if self.has_performed_peak_finding and len(checked_datasets) == 1:
    logger.info(f"检测到数据集切换，自动为数据集 '{checked_datasets[0]['name']}' 执行寻峰")
    self._auto_find_peaks_for_dataset(checked_datasets[0])
```

#### 2.3 在手动寻峰成功后设置标志

**位置**：`FTIR_Processor.py` 第 2999-3000 行

```python
# 设置已执行寻峰标志
self.has_performed_peak_finding = True
logger.info("已设置寻峰标志，后续切换数据集将自动寻峰")
```

#### 2.4 新增内部自动寻峰函数

**位置**：`FTIR_Processor.py` 第 3011-3072 行

```python
def _auto_find_peaks_for_dataset(self, dataset):
    """
    内部函数：自动为指定数据集执行寻峰操作（不显示消息框）
    
    Args:
        dataset: 数据集字典，包含 'name', 'x_data', 'y_data' 等字段
    """
    try:
        x_data = dataset['x_data']
        y_data = dataset['y_data']
        dataset_name = dataset['name']
        
        # 获取当前的寻峰参数
        threshold = float(self.peak_threshold_var.get())
        distance = int(self.peak_distance_var.get())
        
        logger.info(f"自动寻峰: 数据集='{dataset_name}', 阈值={threshold}, 最小距离={distance}")
        
        # 使用PeakAnalyzer进行寻峰
        success, peak_list, error_msg = self.peak_analyzer.find_peaks_auto(
            x_data, y_data, threshold, distance
        )
        
        if not success:
            logger.warning(f"自动寻峰失败: {error_msg}")
            # 清空峰列表
            for item in self.peaks_tree.get_children():
                self.peaks_tree.delete(item)
            return
        
        # 清空现有峰列表
        for item in self.peaks_tree.get_children():
            self.peaks_tree.delete(item)
        
        if len(peak_list) == 0:
            logger.info(f"自动寻峰: 数据集 '{dataset_name}' 未找到符合条件的峰")
            return
        
        # 添加找到的峰（文件名、波数和峰高），并设置交替行背景色
        for idx, (wavenumber, height) in enumerate(peak_list):
            row_tag = 'evenrow' if idx % 2 == 0 else 'oddrow'
            self.peaks_tree.insert(
                '', 'end',
                values=(dataset_name, f"{wavenumber:.2f}", f"{height:.4f}"),
                tags=(row_tag,)
            )
        
        # 配置峰列表的斑马纹背景色
        self.peaks_tree.tag_configure('evenrow', background='white')
        self.peaks_tree.tag_configure('oddrow', background='#F5F5F5')
        
        # 更新图形
        self.update_peak_plot()
        
        logger.info(f"自动寻峰成功: 数据集 '{dataset_name}' 找到 {len(peak_list)} 个峰")
        
    except ValueError as e:
        logger.error(f"自动寻峰参数错误: {str(e)}")
    except Exception as e:
        logger.error(f"自动寻峰出错: {str(e)}")
```

---

## 🧪 测试建议

### 测试 1：图例颜色一致性

1. 启动程序，切换到"特征峰分析"页面
2. 加载 4 个数据集
3. 记录每个数据集的图例颜色
4. 随机勾选/取消勾选数据集
5. 验证每个数据集的颜色始终保持一致

**预期结果**：
- ✅ 每个数据集有固定的颜色
- ✅ 图例颜色与曲线颜色始终一致

---

### 测试 2：自动更新峰列表

1. 启动程序，切换到"特征峰分析"页面
2. 加载 3-4 个数据集
3. 勾选第一个数据集，设置寻峰参数，点击"寻找峰"
4. 切换到第二个数据集（取消勾选第一个，勾选第二个）
5. 验证峰列表自动更新为第二个数据集的特征峰
6. 继续切换到其他数据集，验证自动寻峰功能

**预期结果**：
- ✅ 切换数据集时自动更新峰列表
- ✅ 不显示消息框
- ✅ 峰列表中的"文件名"列正确显示当前数据集名称
- ✅ 日志中记录自动寻峰的详细信息

---

## 📊 影响范围

### 修改的文件
- `FTIR_Processor.py`

### 修改的函数
- `__init__()` - 添加寻峰标志
- `update_peak_plot()` - 修复颜色分配逻辑
- `find_peaks()` - 设置寻峰标志
- `on_dataset_click()` - 添加自动寻峰逻辑
- `_auto_find_peaks_for_dataset()` - 新增内部寻峰函数

### 不受影响的功能
- ✅ 数据加载
- ✅ 平滑处理
- ✅ 基线校正
- ✅ 手动寻峰
- ✅ 峰分析
- ✅ 数据导出
- ✅ 日志管理
- ✅ 所有其他功能

---

## 📁 新增文档

1. **`docs/颜色一致性修复说明.md`**
   - 详细说明图例颜色不一致问题的原因和修复方案
   - 包含测试验证步骤

2. **`docs/自动更新峰列表功能说明.md`**
   - 详细说明自动更新峰列表功能的使用方法
   - 包含实现细节、测试步骤、日志示例

3. **`docs/右键菜单功能说明.md`**
   - 详细说明右键菜单功能的使用方法
   - 包含实现细节、测试步骤、故障排除

4. **`docs/右键菜单测试指南.md`**
   - 完整的测试用例和测试步骤
   - 包含测试结果记录表

5. **`docs/图形残留问题修复说明.md`**
   - 详细说明图形残留问题的原因和修复方案
   - 包含验证方法和技术要点

6. **`docs/矩形选框横坐标顺序修复说明.md`**
   - 详细说明矩形选框横坐标顺序问题的原因和修复方案
   - 包含测试方法和技术要点

7. **`docs/统一空图横坐标范围修复说明.md`**
   - 详细说明统一空图横坐标范围的需求和修复方案
   - 包含测试方法和技术要点

8. **`docs/功能更新总结.md`** (本文档)
   - 汇总本次更新的所有内容
   - 提供快速参考

---

## 🎯 总结

本次更新主要包含三个方面：

1. **Bug 修复**：
   - 解决了图例颜色不一致的问题
   - 修复了图形残留问题
   - 修复了矩形选框横坐标顺序问题

2. **功能增强**：
   - 新增自动更新峰列表功能
   - 新增右键菜单功能（删除记录、取消选择）
   - 统一空图横坐标范围（4000-400 cm⁻¹）

3. **用户体验改进**：
   - 提高了工作效率
   - 增强了操作便捷性
   - 符合 FTIR 光谱图的标准显示习惯
   - 提升了界面一致性

所有修改都经过了仔细的设计和测试，确保不影响现有功能的正常运行。

---

## 📞 技术支持

如有问题，请查看：
- 日志文件：`logs/ftir_processor.log`
- 项目文档：`README.md`
- 详细文档：`docs/` 目录下的相关文档

