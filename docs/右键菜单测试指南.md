# 右键菜单功能测试指南

## 📋 测试目的

验证"特征峰分析"页面中的右键菜单功能是否正常工作，特别是：
1. 删除峰分析记录功能
2. 从图形删除区间功能
3. 取消选择功能
4. **图形残留问题是否已修复**

---

## 🧪 测试环境准备

### 1. 启动程序
```bash
python FTIR_Processor.py
```

### 2. 准备测试数据
- 切换到"特征峰分析"页面
- 加载 1-2 个数据集
- 勾选第一个数据集

### 3. 执行寻峰
- 设置寻峰参数（阈值：0.02，最小距离：10）
- 点击"寻找峰"按钮
- 确认峰列表中有多个峰（至少 5 个）

### 4. 添加峰分析记录
- 在峰列表中选择第一个峰
- 设置区间范围（或使用自动设置）
- 点击"添加到分析"按钮
- 重复 3-5 次，添加多个峰分析记录

---

## 🎯 测试用例

### 测试1：结果列表右键删除功能

#### 步骤
1. 在峰分析结果列表中，右键点击第一行记录
2. 验证弹出右键菜单，显示"删除此记录"选项
3. 点击"删除此记录"
4. 验证弹出确认对话框，显示记录详情
5. 点击"是"确认删除

#### 预期结果
- ✅ 右键菜单正确弹出
- ✅ 确认对话框显示正确的记录信息
- ✅ 结果列表中该记录已消失
- ✅ **图形中对应的绿色区间标记已完全消失（无残留）**
- ✅ 日志中记录了删除操作

#### 检查日志
打开"日志管理"页面，查看最新日志：
```
INFO - 从 analyzed_ranges 删除区间: 原有X个，现有Y个
INFO - 调用 update_peak_plot() 重新绘制图形
INFO - update_peak_plot: 开始更新图形，总数据集数: 1
INFO - update_peak_plot: 图形绘制完成
INFO - 已删除峰分析记录: 文件=XXX, 峰编号=X, 区间=XXX-XXX
```

---

### 测试2：图形区域右键删除已分析区间

#### 步骤
1. 在图形中，找到一个已标记的峰分析区间（绿色虚线和峰编号）
2. 右键点击该区间内的任意位置
3. 验证弹出右键菜单，显示"删除区间分析 (峰#X)"选项
4. 点击删除选项
5. 验证弹出确认对话框
6. 点击"是"确认删除

#### 预期结果
- ✅ 右键菜单正确弹出，显示正确的峰编号
- ✅ 确认对话框显示正确的区间信息
- ✅ **图形中该区间的所有标记已完全消失（无残留）**
- ✅ 结果列表中对应的记录已消失
- ✅ 日志中记录了删除操作

#### 检查日志
```
INFO - 从 analyzed_ranges 删除区间: 原有X个，现有Y个
INFO - 从结果列表删除记录: 峰#X
INFO - 调用 update_peak_plot() 重新绘制图形
INFO - update_peak_plot: 图形绘制完成
INFO - 已从图形中删除区间分析: 峰编号=X, 区间=XXX-XXX
```

---

### 测试3：图形区域右键取消选择

#### 步骤
1. 在峰列表中选择一个峰
2. 在上下限输入框中输入区间范围（或使用自动设置）
3. 验证图形中显示黄色高亮区域
4. 右键点击黄色高亮区域内的任意位置
5. 验证弹出右键菜单，显示"取消选择"选项
6. 点击"取消选择"

#### 预期结果
- ✅ 右键菜单正确弹出
- ✅ **图形中黄色高亮区域已完全消失（无残留）**
- ✅ 上下限输入框已清空
- ✅ 峰列表的选择已清除
- ✅ 已有的分析结果不受影响
- ✅ 日志中记录了操作

#### 检查日志
```
INFO - 已清除峰选择和分析范围
INFO - update_peak_plot: 开始更新图形，总数据集数: 1
INFO - update_peak_plot: 图形绘制完成
```

---

### 测试4：图形区域右键点击空白区域

#### 步骤
1. 在图形中，右键点击空白区域（不在任何区间内）
2. 验证弹出右键菜单

#### 预期结果
- ✅ 右键菜单正确弹出
- ✅ 显示"(无可用操作)"选项（灰色，不可点击）
- ✅ 不影响任何现有数据

---

### 测试5：SpanSelector 重新创建（修复图形残留）

#### 步骤
1. 启用"交互式选择"模式（勾选"交互式选择"复选框）
2. 在图形中拖拽选择一个区间（黄色高亮）
3. 验证上下限输入框自动填充
4. 点击"添加到分析"按钮
5. 右键点击刚添加的区间，选择"删除区间分析"
6. 确认删除
7. **验证图形中没有任何残留的黄色或绿色高亮区域**
8. 再次在图形中拖拽选择一个新区间
9. 验证交互式选择功能仍然正常工作

#### 预期结果
- ✅ 交互式选择功能正常工作
- ✅ 删除后图形完全刷新，无残留
- ✅ SpanSelector 正确重新创建
- ✅ 删除后仍可继续使用交互式选择

#### 检查日志
```
INFO - update_peak_plot: 开始更新图形，总数据集数: 1
INFO - update_peak_plot: 重新创建了 SpanSelector
INFO - update_peak_plot: 图形绘制完成
```

---

### 测试6：多次删除操作（压力测试）

#### 步骤
1. 添加 5-10 个峰分析记录
2. 随机使用以下方式删除记录：
   - 从结果列表右键删除
   - 从图形右键删除
   - 混合使用
3. 每次删除后，仔细检查图形是否有残留
4. 删除所有记录

#### 预期结果
- ✅ 所有删除操作都正常工作
- ✅ **每次删除后图形都完全刷新，无任何残留**
- ✅ 最后图形中没有任何绿色区间标记
- ✅ 结果列表为空
- ✅ 所有操作都记录在日志中

---

### 测试7：切换数据集后的删除操作

#### 步骤
1. 加载 2 个数据集
2. 勾选第一个数据集，添加几个峰分析记录
3. 切换到第二个数据集（取消勾选第一个，勾选第二个）
4. 验证自动寻峰功能正常工作
5. 添加几个峰分析记录
6. 切换回第一个数据集
7. 右键删除一个记录
8. 验证图形正确更新

#### 预期结果
- ✅ 切换数据集时图形正确更新
- ✅ 删除操作在不同数据集间正常工作
- ✅ **图形刷新正确，无残留**
- ✅ 每个数据集的分析记录独立管理

---

## 🔍 关键检查点

### 图形残留检查（最重要）

在每次删除或取消操作后，仔细检查图形中是否有以下残留：

1. **绿色区间标记**：
   - ✅ 绿色虚线（区间边界）
   - ✅ 浅绿色填充区域
   - ✅ 峰编号标注（绿色圆圈）

2. **黄色高亮区域**：
   - ✅ 黄色填充区域（当前选择）
   - ✅ 深灰色虚线（区间边界）
   - ✅ 黑色虚线（基线）
   - ✅ 面积标注

3. **其他可能的残留**：
   - ✅ 任何不应该存在的线条
   - ✅ 任何不应该存在的文本标注
   - ✅ 任何不应该存在的填充区域

### 日志检查

每次操作后，检查日志中是否有：
- ✅ 删除操作的记录
- ✅ `update_peak_plot()` 的调用记录
- ✅ `analyzed_ranges` 的数量变化
- ✅ SpanSelector 重新创建的记录（如果适用）

---

## 📊 测试结果记录

### 测试1：结果列表右键删除
- [ ] 通过
- [ ] 失败（描述问题）：

### 测试2：图形区域右键删除已分析区间
- [ ] 通过
- [ ] 失败（描述问题）：

### 测试3：图形区域右键取消选择
- [ ] 通过
- [ ] 失败（描述问题）：

### 测试4：图形区域右键点击空白区域
- [ ] 通过
- [ ] 失败（描述问题）：

### 测试5：SpanSelector 重新创建
- [ ] 通过
- [ ] 失败（描述问题）：

### 测试6：多次删除操作
- [ ] 通过
- [ ] 失败（描述问题）：

### 测试7：切换数据集后的删除操作
- [ ] 通过
- [ ] 失败（描述问题）：

---

## 🐛 已知问题

### 图形残留问题（已修复）

**问题描述**：
- 删除峰分析记录后，图形上仍然残留有高亮区域

**修复方案**：
- 在 `update_peak_plot()` 中正确处理 `SpanSelector` 的移除和重新创建
- 确保 `clear()` 完全清除所有图形元素

**验证方法**：
- 执行测试5（SpanSelector 重新创建）
- 执行测试6（多次删除操作）
- 仔细检查图形中是否有任何残留

---

## 📞 问题反馈

如果在测试过程中发现任何问题，请：

1. **记录详细信息**：
   - 操作步骤
   - 预期结果
   - 实际结果
   - 截图（如果可能）

2. **查看日志**：
   - 打开"日志管理"页面
   - 查看相关的日志记录
   - 复制相关日志

3. **提供反馈**：
   - 描述问题
   - 附上日志
   - 附上截图

---

## ✅ 测试完成标准

所有测试用例都通过，且：
- ✅ 所有删除操作都正常工作
- ✅ **图形刷新正确，无任何残留**
- ✅ 所有操作都有详细的日志记录
- ✅ 不影响其他功能的正常使用

