# 自动更新峰列表功能说明

## ✨ 功能概述

在"特征峰分析"页面中，新增了**自动更新峰列表**的功能。当用户对某个数据集执行过寻峰操作后，切换到其他数据集时，程序会自动使用相同的寻峰参数对新数据集执行寻峰，并自动更新峰列表。

---

## 🎯 使用场景

### 典型工作流程

1. **加载多个数据集**
   - 用户加载了数据集 A、B、C、D

2. **对第一个数据集寻峰**
   - 勾选数据集 A
   - 设置寻峰参数（阈值：0.02，最小距离：10）
   - 点击"寻找峰"按钮
   - 峰列表显示数据集 A 的特征峰

3. **切换到其他数据集（自动寻峰）**
   - 取消勾选数据集 A，勾选数据集 B
   - ✨ **程序自动使用相同参数对数据集 B 寻峰**
   - 峰列表自动更新为数据集 B 的特征峰
   - **无需手动点击"寻找峰"按钮**

4. **继续切换数据集**
   - 切换到数据集 C、D 时，同样自动寻峰
   - 峰列表始终显示当前勾选数据集的特征峰

---

## 🔧 功能特点

### 1. **智能触发**
- ✅ 仅在已执行过手动寻峰后才启用自动寻峰
- ✅ 仅在单个数据集被勾选时触发（多数据集对比模式下不触发）
- ✅ 使用当前界面上的寻峰参数（阈值、最小距离）

### 2. **静默执行**
- ✅ 自动寻峰不显示成功/失败消息框
- ✅ 所有操作记录在日志中，便于调试
- ✅ 不干扰用户的正常操作流程

### 3. **参数一致性**
- ✅ 自动寻峰使用与手动寻峰相同的参数
- ✅ 用户可以随时修改参数，下次切换时使用新参数
- ✅ 保证所有数据集使用一致的寻峰标准

### 4. **性能优化**
- ✅ 仅在数据集切换时触发，不会频繁执行
- ✅ 使用高效的寻峰算法，响应迅速
- ✅ 不影响其他功能的性能

---

## 📝 实现细节

### 代码修改

#### 1. **添加寻峰标志**（第 119 行）
```python
self.has_performed_peak_finding = False  # 标志：是否已执行过寻峰操作
```

**作用**：
- 跟踪用户是否已经执行过手动寻峰
- 只有在手动寻峰后，才启用自动寻峰功能

#### 2. **修改 `find_peaks()` 函数**（第 2999-3000 行）
```python
# 设置已执行寻峰标志
self.has_performed_peak_finding = True
logger.info("已设置寻峰标志，后续切换数据集将自动寻峰")
```

**作用**：
- 在手动寻峰成功后，设置标志为 True
- 启用后续的自动寻峰功能

#### 3. **修改 `on_dataset_click()` 函数**（第 823-826 行）
```python
# 自动寻峰：如果已经执行过寻峰，且当前只有一个数据集被勾选，则自动更新峰列表
if self.has_performed_peak_finding and len(checked_datasets) == 1:
    logger.info(f"检测到数据集切换，自动为数据集 '{checked_datasets[0]['name']}' 执行寻峰")
    self._auto_find_peaks_for_dataset(checked_datasets[0])
```

**作用**：
- 在数据集勾选状态改变时检查条件
- 如果满足条件，调用自动寻峰函数

#### 4. **新增 `_auto_find_peaks_for_dataset()` 函数**（第 3011-3072 行）
```python
def _auto_find_peaks_for_dataset(self, dataset):
    """
    内部函数：自动为指定数据集执行寻峰操作（不显示消息框）
    
    Args:
        dataset: 数据集字典，包含 'name', 'x_data', 'y_data' 等字段
    """
    # 获取数据和参数
    # 执行寻峰
    # 更新峰列表
    # 记录日志
```

**作用**：
- 执行实际的自动寻峰操作
- 不显示消息框，静默执行
- 所有操作记录在日志中

---

## 🧪 测试验证

### 测试步骤

#### 1. **启动程序**
```bash
python FTIR_Processor.py
```

#### 2. **切换到"特征峰分析"页面**

#### 3. **加载多个数据集**
- 点击"加载数据（可多选）"
- 选择 3-4 个 CSV 文件
- 确认所有数据集都已加载

#### 4. **对第一个数据集手动寻峰**
- 勾选第一个数据集（其他取消勾选）
- 设置寻峰参数：
  - 阈值：0.02
  - 最小距离：10
- 点击"寻找峰"按钮
- 确认峰列表显示该数据集的特征峰

#### 5. **测试自动寻峰**
- 取消勾选第一个数据集
- 勾选第二个数据集
- ✅ **验证**：峰列表自动更新为第二个数据集的特征峰
- ✅ **验证**：没有弹出消息框

#### 6. **继续切换数据集**
- 依次切换到第三、第四个数据集
- ✅ **验证**：每次切换都自动更新峰列表
- ✅ **验证**：峰列表中的"文件名"列正确显示当前数据集名称

#### 7. **测试参数修改**
- 修改寻峰参数（例如：阈值改为 0.03）
- 切换到另一个数据集
- ✅ **验证**：使用新参数进行寻峰

#### 8. **测试多数据集模式**
- 同时勾选 2 个或更多数据集
- ✅ **验证**：不触发自动寻峰
- ✅ **验证**：峰列表保持不变

---

## 📊 日志示例

### 手动寻峰
```
INFO - 设置当前文件名为: 20251118-3%夏季-1
INFO - 已设置寻峰标志，后续切换数据集将自动寻峰
```

### 自动寻峰
```
INFO - 数据集 '20251118-3%夏季-2' 复选框状态: False -> True
INFO - 当前勾选的数据集数量: 1
INFO - 切换到单数据集模式：20251118-3%夏季-2，更新current_file_name为: 20251118-3%夏季-2
INFO - 检测到数据集切换，自动为数据集 '20251118-3%夏季-2' 执行寻峰
INFO - 自动寻峰: 数据集='20251118-3%夏季-2', 阈值=0.02, 最小距离=10
INFO - 自动寻峰成功: 数据集 '20251118-3%夏季-2' 找到 15 个峰
```

### 多数据集模式（不触发自动寻峰）
```
INFO - 当前勾选的数据集数量: 2
INFO - update_peak_plot: 开始绘制 2 个数据集
```

---

## ⚠️ 注意事项

### 1. **首次使用必须手动寻峰**
- 自动寻峰功能仅在首次手动寻峰后启用
- 如果从未点击过"寻找峰"按钮，切换数据集不会触发自动寻峰

### 2. **仅在单数据集模式下触发**
- 当同时勾选多个数据集时（对比模式），不会触发自动寻峰
- 这是为了避免在对比分析时干扰用户操作

### 3. **参数实时生效**
- 自动寻峰使用当前界面上的参数
- 修改参数后，下次切换数据集时会使用新参数

### 4. **静默执行**
- 自动寻峰不显示成功/失败消息框
- 如果需要查看详细信息，请查看日志文件

---

## 🔍 故障排除

### 问题1：切换数据集后峰列表没有自动更新

**可能原因**：
- 从未执行过手动寻峰
- 同时勾选了多个数据集

**解决方法**：
1. 确保已经对至少一个数据集执行过手动寻峰
2. 确保只勾选了一个数据集

### 问题2：自动寻峰找不到峰

**可能原因**：
- 当前数据集的峰不明显
- 寻峰参数不适合当前数据集

**解决方法**：
1. 调整寻峰参数（降低阈值或减小最小距离）
2. 查看日志文件了解详细信息

### 问题3：想要禁用自动寻峰

**解决方法**：
- 目前没有提供禁用开关
- 如果不想自动寻峰，可以同时勾选多个数据集（对比模式）

---

## 📁 影响范围

### 修改的文件
- `FTIR_Processor.py`

### 修改的函数
- `__init__()` - 添加寻峰标志
- `find_peaks()` - 设置寻峰标志
- `on_dataset_click()` - 添加自动寻峰逻辑
- `_auto_find_peaks_for_dataset()` - 新增内部寻峰函数

### 不受影响的功能
- ✅ 数据加载
- ✅ 平滑处理
- ✅ 基线校正
- ✅ 手动寻峰
- ✅ 峰分析
- ✅ 数据导出
- ✅ 日志管理
- ✅ 所有其他功能

---

## 🎯 总结

**功能**：自动更新峰列表

**触发条件**：
1. 已执行过手动寻峰
2. 只勾选了一个数据集
3. 数据集勾选状态发生变化

**执行方式**：
- 静默执行，不显示消息框
- 使用当前界面上的寻峰参数
- 所有操作记录在日志中

**优势**：
- 提高工作效率，无需重复点击"寻找峰"按钮
- 保证所有数据集使用一致的寻峰参数
- 不干扰用户的正常操作流程

---

## 📞 技术支持

如有问题，请查看：
- 日志文件：`logs/ftir_processor.log`
- 项目文档：`README.md`

