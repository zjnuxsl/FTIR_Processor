# 图例颜色一致性问题修复说明

## 🐛 问题描述

在"特征峰分析"页面中，存在图例颜色不一致的问题：

**问题表现：**
1. ✅ 初始状态：首次加载数据集并勾选时，图形区域的光谱曲线颜色与左侧"已加载数据集"列表中的图例颜色一致
2. ❌ 问题出现：取消勾选某个数据集后，再重新勾选该数据集，图形区域的曲线颜色与列表中的图例颜色不再匹配

**示例场景：**
```
加载 4 个数据集：
- 数据集1 (蓝色)  ☑
- 数据集2 (红色)  ☑
- 数据集3 (绿色)  ☑
- 数据集4 (橙色)  ☑

取消勾选数据集2：
- 数据集1 (蓝色)  ☑  → 图中显示蓝色 ✅
- 数据集2 (红色)  ☐
- 数据集3 (绿色)  ☑  → 图中显示红色 ❌ (应该是绿色)
- 数据集4 (橙色)  ☑  → 图中显示绿色 ❌ (应该是橙色)
```

---

## 🔍 问题根本原因

### 代码分析

**问题代码位置：** `FTIR_Processor.py` 第 2447-2448 行

```python
# ❌ 错误的实现
for idx, dataset in enumerate(checked_datasets):
    color = self.dataset_colors[idx % len(self.dataset_colors)]
```

**问题原因：**
- 使用 `checked_datasets` 列表的索引 `idx` 来分配颜色
- `checked_datasets` 是动态过滤的列表，只包含勾选的数据集
- 当取消勾选某些数据集后，`checked_datasets` 的索引会改变
- 导致同一个数据集在不同时刻被分配不同的颜色

**对比：图例颜色分配**

在 `update_datasets_tree()` 函数（第 716 行）：
```python
# ✅ 正确的实现
for idx, dataset in enumerate(self.loaded_datasets):
    color = self.dataset_colors[idx % len(self.dataset_colors)]
```

- 使用 `loaded_datasets` 的索引，这是固定的
- 每个数据集始终有相同的颜色

---

## ✅ 修复方案

### 修复代码

**修改位置：** `FTIR_Processor.py` 第 2445-2453 行

```python
# ✅ 修复后的代码
# 显示勾选的数据集
logger.info(f"update_peak_plot: 开始绘制 {len(checked_datasets)} 个数据集")
for dataset in checked_datasets:
    # 找到该数据集在 loaded_datasets 中的原始索引，以保持颜色一致
    original_idx = next(i for i, ds in enumerate(self.loaded_datasets) if ds['name'] == dataset['name'])
    color = self.dataset_colors[original_idx % len(self.dataset_colors)]
    logger.info(f"  绘制数据集: '{dataset['name']}', 原始索引: {original_idx}, 颜色: {color}, 数据点数: {len(dataset['x_data'])}")
    self.peak_ax.plot(dataset['x_data'], dataset['y_data'],
                    color=color, label=dataset['name'], linewidth=1.5)
```

### 修复原理

1. **查找原始索引**：
   - 对于每个勾选的数据集，在 `loaded_datasets` 中查找其原始索引
   - 使用 `next()` 和生成器表达式快速查找

2. **使用原始索引分配颜色**：
   - 使用 `original_idx` 而不是 `checked_datasets` 的索引
   - 确保每个数据集始终使用相同的颜色

3. **增强日志**：
   - 添加 `original_idx` 到日志输出
   - 便于调试和验证

---

## 🧪 测试验证

### 测试步骤

1. **启动程序**
   ```bash
   python FTIR_Processor.py
   ```

2. **切换到"特征峰分析"页面**

3. **加载多个数据集**
   - 点击"加载数据（可多选）"
   - 选择 4 个或更多 CSV 文件
   - 观察左侧列表中每个数据集的颜色图例

4. **验证初始状态**
   - 确认所有数据集都被勾选
   - 确认图形区域的曲线颜色与列表中的图例颜色一致

5. **测试取消勾选**
   - 取消勾选第 2 个数据集
   - 观察图形更新
   - ✅ 验证：剩余数据集的颜色应该保持不变

6. **测试重新勾选**
   - 重新勾选第 2 个数据集
   - 观察图形更新
   - ✅ 验证：第 2 个数据集应该恢复其原始颜色

7. **测试多次切换**
   - 随机勾选/取消勾选不同的数据集
   - 每次都验证颜色是否一致
   - ✅ 验证：每个数据集的颜色应该始终固定

### 预期结果

**修复前：**
```
数据集1 (蓝色)  ☑  → 蓝色 ✅
数据集2 (红色)  ☐
数据集3 (绿色)  ☑  → 红色 ❌
数据集4 (橙色)  ☑  → 绿色 ❌
```

**修复后：**
```
数据集1 (蓝色)  ☑  → 蓝色 ✅
数据集2 (红色)  ☐
数据集3 (绿色)  ☑  → 绿色 ✅
数据集4 (橙色)  ☑  → 橙色 ✅
```

---

## 📝 日志验证

修复后，日志会显示原始索引信息：

```
update_peak_plot: 开始绘制 3 个数据集
  绘制数据集: '数据集1', 原始索引: 0, 颜色: blue, 数据点数: 1000
  绘制数据集: '数据集3', 原始索引: 2, 颜色: green, 数据点数: 1000
  绘制数据集: '数据集4', 原始索引: 3, 颜色: orange, 数据点数: 1000
```

注意：
- 即使只绘制 3 个数据集，原始索引仍然是 0, 2, 3
- 颜色与原始索引对应，而不是当前绘制顺序

---

## ✅ 影响范围

### 修改的函数
- `update_peak_plot()` - 更新特征峰分析图形

### 不受影响的功能
- ✅ 数据加载
- ✅ 平滑处理
- ✅ 基线校正
- ✅ 峰检测和分析
- ✅ 数据导出
- ✅ 日志管理
- ✅ 其他所有功能

### 性能影响
- 微小的性能开销（查找原始索引）
- 对于少量数据集（< 10），影响可忽略不计

---

## 🎯 总结

**问题：** 图例颜色与曲线颜色不一致

**原因：** 使用动态列表索引分配颜色

**修复：** 使用固定的原始索引分配颜色

**结果：** 每个数据集始终保持固定的颜色，无论勾选状态如何变化

---

## 📞 技术支持

如有问题，请查看：
- 日志文件：`logs/ftir_processor.log`
- 项目文档：`README.md`

