# FTIR光谱处理器 (FTIR Processor)

一个功能完整的傅里叶变换红外光谱（FTIR）数据处理工具，提供数据平滑、基线校正和峰分析功能。

## ✨ 特性

- 🎯 **多种平滑算法**: Savitzky-Golay、LOWESS（局部加权回归）、移动平均、高斯滤波、中值滤波
- 📊 **基线校正**: Rubberband、修正多项式、Whittaker-ASLS等5种方法
- 🔍 **峰分析**:
  - 自动寻峰、峰参数分析（高度、面积）
  - 多数据集对比分析
  - 交互式峰选择
  - 批量峰分析
  - 图形缩放和导航工具
- 🖥️ **友好界面**: 基于Tkinter的图形界面，操作简单直观
- 📈 **实时可视化**: 集成Matplotlib，实时显示处理结果
- 💾 **数据导出**: 支持CSV格式导入导出
- 📝 **日志管理**: 内置日志查看、筛选和导出功能
- 🏗️ **模块化设计**: 代码结构清晰，易于维护和扩展

## 📋 系统要求

- **Python**: 3.8 或更高版本
- **操作系统**: Windows 10/11, macOS 10.14+, Linux (Ubuntu 18.04+)

## 🚀 快速开始

### Windows 用户（推荐）

1. **确保已安装 Python 3.8+**

   - 下载：https://www.python.org/downloads/
   - 安装时勾选 "Add Python to PATH"
2. **进入 `scripts` 目录，双击 `install.bat`**（首次使用）

   - 自动创建虚拟环境并安装依赖
3. **双击 `run.bat` 启动程序**

### 手动安装

```bash
# 1. 安装依赖
pip install -r requirements.txt

# 2. 运行程序
python FTIR_Processor.py
```

## 📦 依赖包

核心依赖包会通过 `requirements.txt` 自动安装：

- **numpy** (>=1.20.0) - 数值计算
- **pandas** (>=1.3.0) - 数据处理
- **matplotlib** (>=3.4.0) - 数据可视化
- **scipy** (>=1.7.0) - 科学计算
- **statsmodels** (>=0.13.0) - 统计分析
- **pybaselines** (>=1.0.0) - 基线校正

## 📖 功能说明

### 数据格式要求

- **文件格式**: CSV 格式
- **数据列**: 至少包含两列
  - 第一列：波数 (cm⁻¹)
  - 第二列：吸光度/透过率值
- **数据排序**: 建议按波数排序

---

### 1️⃣ 平滑处理模块

#### 支持的平滑方法

| 方法                             | 适用场景                       | 主要参数             |
| -------------------------------- | ------------------------------ | -------------------- |
| **Savitzky-Golay（推荐）** | 保持峰形状，适合大多数FTIR光谱 | 窗口长度、多项式阶数 |
| **LOWESS**                 | 非线性趋势数据，局部加权平滑   | 平滑分数、迭代次数   |
| **移动平均**               | 简单快速，噪声较大但峰形不重要 | 窗口长度             |
| **高斯滤波**               | 正态分布噪声，平滑效果温和     | 标准差 σ            |
| **中值滤波**               | 去除尖峰噪声和离群值           | 窗口长度             |

#### 方法详细说明

**1. Savitzky-Golay 滤波（最适合FTIR光谱）**

- 通过局部多项式回归计算平滑值
- 能很好地保持峰的形状和位置
- 适用于需要保持光谱精细结构的情况
- **参数说明**：
  - 窗口长度：必须为奇数，范围5-51，默认11。越大越平滑
  - 多项式阶数：范围1-9，默认3。通常2-4，越小越平滑

**2. LOWESS（局部加权散点平滑）**

- 局部加权散点平滑法
- 适用于非线性趋势数据
- 计算较慢但效果好
- **参数说明**：
  - 平滑分数：范围0.05-0.5，默认0.2。越大越平滑
  - 迭代次数：范围1-10，默认3。通常3次即可

**3. 移动平均**

- 简单的数据平滑方法
- 计算滑动窗口内数据点的平均值
- 适用于噪声较大但峰形状不重要的情况
- **参数说明**：
  - 窗口长度：范围3-51，默认5。越大越平滑

**4. 高斯滤波**

- 使用高斯函数作为权重的加权平均
- 对正态分布噪声效果较好
- 平滑效果温和，不会过度失真
- **参数说明**：
  - 标准差 σ：范围0.5-10，默认1.0。越大越平滑

**5. 中值滤波**

- 取滑动窗口内的中位数
- 对突变噪声（离群值）效果好
- 可能会改变峰的形状
- **参数说明**：
  - 窗口长度：范围3-51，默认5。越大越平滑

#### 操作步骤

1. 点击 **📁 加载数据** 导入 CSV 文件
2. （可选）在 **数据范围选择** 中设置处理范围
   - 输入起始值和终止值
   - 点击"添加范围"
   - 可添加多个范围
3. 在 **平滑方法** 下拉框中选择方法
4. 使用 **滑块** 调整参数（实时显示当前值）
5. （可选）勾选 **实时预览** 查看效果
6. 点击 **✓ 应用平滑** 执行处理
7. 如需撤销，点击 **↶ 撤销**
8. 点击 **💾 导出数据** 保存结果

---

### 2️⃣ 基线校正模块

#### 支持的校正方法

| 方法                         | 适用场景                     | 主要参数                 |
| ---------------------------- | ---------------------------- | ------------------------ |
| **Rubberband（推荐）** | FTIR光谱最常用，基线漂移明显 | 无需参数                 |
| **修正多项式**         | 简单基线漂移，计算快速       | 多项式阶数               |
| **自适应迭代多项式**   | 复杂基线形状，自动优化       | 多项式阶数、最大迭代次数 |
| **Whittaker-ASLS**     | 噪声数据，结合平滑和校正     | 平滑参数λ、非对称参数p  |
| **平滑样条**           | 连续变化的基线，灵活性好     | 平滑参数λ               |

#### 方法详细说明

**1. Rubberband（橡皮带法，最适合FTIR基线校正）**

- 橡皮带法，最适合FTIR基线校正
- 在光谱下方创建凸包
- 自动识别基线点
- 适用于基线漂移明显的光谱
- **无需参数**

**2. 修正多项式**

- 传统多项式拟合方法
- 简单直观，计算快速
- 适用于简单基线漂移
- **参数说明**：
  - 多项式阶数：通常2-5，默认3

**3. 自适应迭代多项式**

- 自动寻找最优多项式拟合
- 迭代优化以找到最佳基线
- 适用于复杂基线形状
- **参数说明**：
  - 多项式阶数：通常2-5，默认3
  - 最大迭代次数：默认50

**4. Whittaker-ASLS**

- 结合平滑和基线校正
- 自适应权重迭代
- 对噪声数据效果好
- **参数说明**：
  - 平滑参数 λ：默认1e6，越大越平滑
  - 非对称参数 p：默认0.01，控制基线位置

**5. 平滑样条**

- 使用样条函数拟合基线
- 灵活性好，可调节平滑度
- 适用于连续变化的基线
- **参数说明**：
  - 平滑参数 λ：默认1e5，越大越平滑

#### 操作步骤

1. 选择 **数据源**（原始数据或平滑后数据）
2. 在 **基线校正方法** 中选择方法
3. 设置相应参数
4. 点击 **执行校正** 进行处理
5. 点击 **💾 导出数据** 保存结果

---

### 3️⃣ 特征峰分析模块

#### 支持的功能

- ✅ **多数据集管理**：

  - 同时加载多个数据集
  - 勾选/取消勾选数据集进行对比
  - 数据集列表显示和管理
- ✅ **自动寻峰**：

  - 根据阈值和最小距离自动识别特征峰
  - 峰列表显示文件名、波数、峰高
  - 支持多选峰进行批量分析
- ✅ **交互式峰选择**：

  - 在图形上点击选择峰
  - 自动定位到最近的峰
  - 实时显示峰信息
- ✅ **峰参数分析**：

  - 峰位置（波数）
  - 峰高度（原始数据和校正后数据）
  - 峰面积（积分计算）
  - 分析区间设置
- ✅ **图形工具**：

  - 矩形选框缩放
  - 平移模式
  - 缩放历史（后退/前进）
  - 重置视图
  - 鼠标悬停显示峰信息
- ✅ **批量分析**：

  - 批量分析所有峰
  - 固定积分区间选项
  - 分析结果表格显示
- ✅ **导出功能**：

  - 导出峰列表（CSV格式）
  - 导出分析结果（包含所有峰参数）
  - 双击单元格复制数值

#### 参数说明

| 参数               | 说明                             | 建议值                             |
| ------------------ | -------------------------------- | ---------------------------------- |
| **阈值**     | 峰识别的最小高度                 | 根据数据噪声水平调整，通常0.01-0.1 |
| **最小距离** | 相邻峰之间的最小间隔（数据点数） | 5-20，取决于数据密度               |
| **区间下限** | 峰面积积分的起始波数             | 峰左侧基线位置                     |
| **区间上限** | 峰面积积分的结束波数             | 峰右侧基线位置                     |

#### 操作步骤

**基础操作**：

1. 点击 **加载数据（可多选）** 导入一个或多个CSV文件
2. 在数据集列表中勾选要分析的数据集
3. 选择 **数据源**（原始/平滑/基线校正后数据）
4. 设置 **峰检测参数**（阈值、最小距离）
5. 点击 **寻找峰** 进行自动峰检测

**单峰分析**：

1. 在峰列表中选择一个峰
2. 设置分析范围（下限和上限波数）
3. 点击 **添加到分析列表** 或 **重新分析**
4. 查看分析结果表格中的峰参数

**批量分析**：

1. 勾选 **固定积分区间**
2. 设置统一的下限和上限
3. 点击 **批量分析所有峰**
4. 所有峰的分析结果会显示在表格中

**交互式选择**：

1. 勾选 **交互式选择**
2. 在图形上点击峰的位置
3. 程序自动定位到最近的峰并显示信息

**图形操作**：

- 选择 **矩形选框** 模式，在图上拖动选择区域进行缩放
- 选择 **平移** 模式，拖动图形进行平移
- 使用 **后退/前进** 按钮浏览缩放历史
- 点击 **重置** 恢复原始视图
- 鼠标悬停在峰上查看详细信息

**数据导出**：

1. 点击 **导出峰列表** 保存所有检测到的峰
2. 点击 **导出结果** 保存分析结果表格
3. 双击分析结果表格的单元格可快速复制数值

#### 注意事项

⚠️ **建议**：

- 在进行峰分析前先进行数据平滑和基线校正
- 使用基线校正后的数据进行峰分析，结果更准确
- 对于多数据集对比，建议使用相同的峰检测参数

⚠️ **参数设置**：

- 阈值过低 → 噪声被误识别为峰
- 阈值过高 → 小峰被忽略
- 最小距离过小 → 单个峰被多次识别
- 最小距离过大 → 相邻峰被合并

⚠️ **数据源影响**：

- 原始数据：可能受噪声影响
- 平滑后数据：峰形更清晰，但可能丢失细节
- 基线校正后数据：峰高度和面积更准确（推荐）

⚠️ **多数据集分析**：

- 同时勾选多个数据集时，只能查看对比图形
- 峰分析需要单独勾选一个数据集
- 切换数据集后需要重新寻峰

---

### 4️⃣ 日志管理模块

#### 支持的功能

- ✅ **日志查看**：实时查看程序运行日志
- ✅ **日志筛选**：
  - 按日志级别筛选（DEBUG、INFO、WARNING、ERROR、CRITICAL）
  - 按关键词搜索
- ✅ **日志管理**：
  - 刷新日志
  - 清空日志文件
  - 导出日志到文本文件
- ✅ **颜色标记**：不同级别的日志使用不同颜色显示

#### 操作步骤

1. 切换到 **日志管理** 标签页
2. 查看日志内容（自动加载）
3. （可选）选择日志级别进行筛选
4. （可选）在搜索框输入关键词
5. 点击 **刷新日志** 重新加载最新日志
6. 点击 **导出日志** 保存当前显示的日志
7. 点击 **清空日志** 清空日志文件（需确认）

#### 日志级别说明

| 级别               | 颜色       | 说明                         |
| ------------------ | ---------- | ---------------------------- |
| **DEBUG**    | 灰色       | 调试信息，详细的程序执行过程 |
| **INFO**     | 黑色       | 一般信息，正常的操作记录     |
| **WARNING**  | 橙色       | 警告信息，可能的问题         |
| **ERROR**    | 红色       | 错误信息，操作失败           |
| **CRITICAL** | 深红色加粗 | 严重错误，程序可能崩溃       |

## ⚠️ 使用建议

- **数据处理流程**：建议先平滑处理 → 基线校正 → 峰分析
- **参数调整**：从默认值开始，根据效果逐步调整
- **数据保存**：及时导出处理结果
- **多数据集对比**：使用相同的处理参数以便对比

## ❓ 常见问题

**Q: 程序无法启动？**

- 确保已安装 Python 3.8+
- 检查是否已运行 `install.bat` 安装依赖

**Q: 峰检测不准确？**

- 调整阈值和最小距离参数
- 建议先进行平滑和基线校正

**Q: 如何对比多个数据集？**

- 加载多个文件后，勾选要对比的数据集
- 图形会自动叠加显示

**Q: 如何复制分析结果？**

- 双击分析结果表格的单元格即可复制数值

---

## 📁 项目结构

```
FTIR_Processor/
├── FTIR_Processor.py          # 主程序入口（GUI + 控制逻辑）
├── requirements.txt            # Python依赖列表
├── README.md                   # 项目说明文档
├── .gitignore                  # Git忽略文件配置
│
├── src/                        # 业务逻辑模块（独立的功能模块）
│   ├── __init__.py            # 模块初始化
│   ├── data_manager.py        # 数据管理（加载、存储、验证）
│   ├── smoothing_processor.py # 平滑处理（5种平滑算法）
│   ├── baseline_corrector.py  # 基线校正（5种校正方法）
│   └── peak_analyzer.py       # 峰分析（峰检测、积分计算）
│
├── scripts/                    # 脚本文件
│   ├── install.bat            # Windows安装脚本
│   ├── run.bat                # Windows运行脚本
│   ├── build_exe.bat          # Windows打包脚本
│   └── README.md              # 脚本使用说明
│
├── data/                       # 数据目录
│   ├── input/                 # 输入数据（测试数据）
│   │   ├── test1.CSV         # 示例数据1
│   │   └── test2.CSV         # 示例数据2
│   └── output/                # 输出数据（处理结果）
│       └── .gitkeep          # 保持目录结构
│
├── logs/                       # 日志目录
│   └── ftir_processor.log    # 程序运行日志
│
└── docs/                       # 文档目录
    └── .gitkeep               # 保持目录结构
```
